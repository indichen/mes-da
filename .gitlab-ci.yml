image: registry.walsin.im:5000/cloud.walsin.com/python3-executor

stages:
  - deploy

variables:
  GRADLE_USER_HOME: ${CI_PROJECT_DIR}
  DA_SERVER: "10.190.254.118"
  DA_SERVER_PATH: "/opt/da-service"
  DA_SERVER_WEBROOT: "/opt/da-service/webroot"
  COMMIT_ID: ${CI_COMMIT_SHORT_SHA}
  TARBALL: ${CI_COMMIT_SHORT_SHA}.tar.gz

scmes_deploy:
  type: deploy
  only:
    changes:
      - SCMES/*.html
      - SCMES/**/*.html
      - SCMES/*.sql
  environment:
    name: da-service-scmes
    url: http://wcp-edge-ap1:3333/SCMES/
  script:
    - echo "[da-service] Deploying SCMES..."
    - echo "[da-service] CI_COMMIT_SHORT_SHA=${CI_COMMIT_SHORT_SHA}"
    - tar zcf ${TARBALL} -T SCMES/deploy.txt -C SCMES/
    - scp ${TARBALL} root@${DA_SERVER}:/tmp
    - ssh root@${DA_SERVER} "cd /tmp && mkdir -p ${DA_SERVER_WEBROOT}/SCMES/${COMMIT_ID} && tar zxf ${TARBALL} -C ${DA_SERVER_WEBROOT}/SCMES/${COMMIT_ID} && cd ${DA_SERVER_WEBROOT}/SCMES/ && rm -f latest && ln -s ${COMMIT_ID} latest" 
    - echo "[da-service] Done"

ytmes_deploy:
  type: deploy
  only:
    changes:
      - YTMES/*.html
      - YTMES/**/*.html
      - YTMES/*.sql
  environment:
    name: da-service-ytmes
    url: http://wcp-edge-ap1:3333/YTMES/
  script:
    - echo "[da-service] Deploying YTMES..."
    - echo "[da-service] CI_COMMIT_SHORT_SHA=${CI_COMMIT_SHORT_SHA}"
    - tar zcf ${TARBALL} -T YTMES/deploy.txt -C YTMES/
    - scp ${TARBALL} root@${DA_SERVER}:/tmp
    - ssh root@${DA_SERVER} "cd /tmp && mkdir -p ${DA_SERVER_WEBROOT}/YTMES/${COMMIT_ID} && tar zxf ${TARBALL} -C ${DA_SERVER_WEBROOT}/YTMES/${COMMIT_ID} && cd ${DA_SERVER_WEBROOT}/YTMES/ && rm -f latest && ln -s ${COMMIT_ID} latest" 
    - echo "[da-service] Done"

fm_deploy:
  type: deploy
  only:
    changes:
      - FactoryModel/*.html
      - FactoryModel/**/*.html
      - FactoryModel/*.sql
  environment:
    name: da-service-factorymodel
    url: http://wcp-edge-ap1:3333/FactoryModel/
  script:
    - echo "[da-service] Deploying FactoryModel..."
    - echo "[da-service] CI_COMMIT_SHORT_SHA=${CI_COMMIT_SHORT_SHA}"
    - tar zcf ${TARBALL} -T FactoryModel/deploy.txt -C FactoryModel/
    - scp ${TARBALL} root@${DA_SERVER}:/tmp
    - ssh root@${DA_SERVER} "cd /tmp && mkdir -p ${DA_SERVER_WEBROOT}/FactoryModel/${COMMIT_ID} && tar zxf ${TARBALL} -C ${DA_SERVER_WEBROOT}/FactoryModel/${COMMIT_ID} && cd ${DA_SERVER_WEBROOT}/FactoryModel/ && rm -f latest && ln -s ${COMMIT_ID} latest" 
    - echo "[da-service] Done"